<script lang="ts">
	import '../app.css';
  import { onMount } from 'svelte';
  import { goto } from '$app/navigation';
  import { textParser } from '$lib/shared';
  import { page } from '$app/stores';
  import UAParser from 'ua-parser-js';
  import clsx from 'clsx';

	function accessible() {
		document.body.classList.add('accessible');
	}

  let caretPos = 0;
  let averageCharWidth = 0;
  let input: HTMLInputElement;
  let fancy: HTMLSpanElement;
  $: customCaret = false;

  onMount(() => {
    // Create a temporary span with the same font
    const tempSpan = document.createElement('span');
    tempSpan.textContent = 'A'; // Use a representative character
    document.body.appendChild(tempSpan);

    // Measure the character width
    averageCharWidth = tempSpan.getBoundingClientRect().width;
    document.body.removeChild(tempSpan);

    const ua = UAParser(navigator.userAgent);
    customCaret = ua.browser.name?.toLowerCase().includes("firefox") ?? false;

    input = document.getElementById("command") as HTMLInputElement;
    fancy = document.getElementById("formattedCommandText") as HTMLSpanElement;
  });

  function handleCaret() {
    input.selectionStart = input.selectionEnd;
    fancy.innerHTML = textParser.render(input.value);
    caretPos = input.selectionEnd ?? input.value.length;
  }

  function handleCommand(event: any) {
    if (event.keyCode === 13) {
      if (input.value.toLowerCase() === "nav.back") {
        const path = $page.url.pathname
        if (path.startsWith("/books/") || path.startsWith("/publishers/")) {
          goto("/library")
        } else if (path === "/library") {
          goto("/")
        } else if (path === "/") {
          // Do nothing
        } else {
          history.back();
        }
      } else if (input.value.toLowerCase() === "twitch.tv") {
        window.location.assign("https://twitch.tv/piratesoftware")
      }

      input.value = "";
      fancy.innerHTML = "";
      handleCaret();
    }
  }
</script>

<slot />
<div class="relative">
  <label for="command" class="text-custom-1">:</label><input
  autocomplete="off" autofocus
  class={clsx(
    "command",
    {hide_caret: customCaret}
  )}
  id="command"
  on:input={handleCaret}
  on:selectionchange={handleCaret}
  on:keypress={handleCommand}
  spellcheck="false" />
  <span class="absolute" style="left: {averageCharWidth}px;" id="formattedCommandText"></span>
  <span class={clsx("fake-caret", {hidden: !customCaret})} style="left: {caretPos * averageCharWidth + averageCharWidth}px;"/>
</div>
<span aria-hidden="true" id="command_width" class="hidden absolute top-[-5rem] left-[-5rem]"></span>

<button
	class="scale-[.07] w-fit fixed right-0 bottom-0 overflow-hidden mx-[-32rem] my-[-30.7rem] text-left accessibility-button"
  aria-label="accessibility mode, more readable text"
	on:click={accessible}>
	<pre>
                                          ████████████████
                                    ████████████████████████████
                                ████████████████████████████████████
                             ██████████████████████████████████████████
                          ████████████████████████████████████████████████
                        ████████████████████████████████████████████████████
                      ████████████████████                ████████████████████
                    █████████████████                          █████████████████
                  ████████████████         ███████████████        ████████████████
                 ██████████████       ████████████████████████       ██████████████
               ██████████████     ████████████████████████████████      █████████████
              █████████████    ██████████████████████████████████████    █████████████
             ████████████    ██████████████████████████████████████████    ████████████
            ███████████    ██████████████████████████████████████████████    ███████████
           ███████████    ████████████████████████████████████████████████    ███████████
          ██████████    ██████████████████████        ██████████████████████    ██████████
         ██████████    ██████████████████████          ██████████████████████    ██████████
        ██████████   ███████████████████████            ███████████████████████   ██████████
       ██████████   ███████████████████████              ███████████████████████   ██████████
      ██████████   ████████████████████████              ████████████████████████   ██████████
      █████████   █████████████████████████              █████████████████████████   █████████
     █████████   ███████████████████████████            ███████████████████████████   █████████
     █████████   ████████████████████████████          ████████████████████████████   █████████
    █████████   ██████████████████████████████        ██████████████████████████████   █████████
    █████████  ███████████     ██████████████████████████████████████     ███████████  █████████
   █████████   ██████████            ██████████████████████████            ██████████   █████████
   █████████  ███████████                                                  ███████████  █████████
   ████████   ████████████                                                ████████████   ████████
  █████████  ████████████████                                          ████████████████  █████████
  █████████  ██████████████████████                              ██████████████████████   ████████
  ████████   ██████████████████████████████              ██████████████████████████████   ████████
  ████████   ██████████████████████████████              ██████████████████████████████   ████████
 █████████  ███████████████████████████████              ███████████████████████████████  █████████
 █████████  ███████████████████████████████              ███████████████████████████████  █████████
 █████████  ███████████████████████████████              ███████████████████████████████  █████████
 █████████  ███████████████████████████████              ███████████████████████████████  █████████
 █████████  ███████████████████████████████              ███████████████████████████████  █████████
 █████████  ███████████████████████████████              ███████████████████████████████  █████████
 █████████  ███████████████████████████████              ███████████████████████████████  █████████
  ████████   ██████████████████████████████              ██████████████████████████████   ████████
  ████████   ██████████████████████████████              ██████████████████████████████   ████████
  ████████   ██████████████████████████████              ██████████████████████████████   ████████
  █████████  █████████████████████████████                █████████████████████████████  █████████
   ████████   ████████████████████████████       ██       ████████████████████████████   ████████
   █████████  ████████████████████████████       ██       ████████████████████████████  █████████
   █████████   ███████████████████████████      ████      ███████████████████████████   █████████
    █████████  ██████████████████████████       ████       ██████████████████████████  █████████
    █████████   █████████████████████████       ████       █████████████████████████   █████████
     █████████   ████████████████████████       ████       ████████████████████████   █████████
     █████████   ███████████████████████       ██████       ███████████████████████   █████████
      █████████   ██████████████████████       ██████       ██████████████████████   █████████
      ██████████   ████████████████████       ████████       ████████████████████   ██████████
       ██████████   ███████████████████       ████████       ███████████████████   ██████████
        ██████████   █████████████████       ██████████       █████████████████   ██████████
         ██████████    ███████████████       ███████████      ███████████████    ██████████
          ██████████    ███████████████     ████████████     ███████████████    ██████████
           ███████████    ████████████████████████████████████████████████    ███████████
            ███████████    ██████████████████████████████████████████████    ███████████
             ████████████    ██████████████████████████████████████████    ████████████
              █████████████    ██████████████████████████████████████     ████████████
               ██████████████     ████████████████████████████████      █████████████
                 ██████████████      ██████████████████████████      ██████████████
                  ████████████████        ████████████████        ████████████████
                    █████████████████                          █████████████████
                      ████████████████████                ████████████████████
                        ████████████████████████████████████████████████████
                          ████████████████████████████████████████████████
                             ██████████████████████████████████████████
                                ████████████████████████████████████
                                    ████████████████████████████
                                          ████████████████
</pre>
</button>

<style>
  #formattedCommandText {
    z-index: -1;
    user-select: none;
  }

  .fake-caret {
    position: absolute;
    right: 5px; /* Adjust based on padding */
    top: 50%;
    transform: translateY(-50%);
    width: 2px;
    height: 80%;
    background-color: white;
    animation: blink 600ms infinite; /* Add blinking animation */
  }

  @keyframes blink {
    0% { opacity: 1; }
    100% { opacity: .5; }
  }
</style>

